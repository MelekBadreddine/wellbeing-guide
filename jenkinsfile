pipeline {
    agent any

    environment {
        DOCKER_USERNAME = credentials('DOCKER_USERNAME')
        DOCKER_PASSWORD = credentials('DOCKER_PASSWORD')
        KUBE_CONFIG = credentials('KUBE_CONFIG')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            agent {
                docker {
                    image 'subosito/flutter:2.x'
                }
            }
            steps {
                sh 'flutter pub get'
                sh 'flutter analyze'
                sh 'flutter build apk'
            }
        }

        stage('Build and Push Docker Image') {
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', DOCKER_USERNAME, DOCKER_PASSWORD) {
                        def image = docker.build('chatbot:latest', '.')
                        image.push()
                    }
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    withCredentials([file(credentialsId: 'KUBE_CONFIG', variable: 'KUBE_CONFIG_FILE')]) {
                        sh 'kubectl apply -f deployment.yaml --kubeconfig=$KUBE_CONFIG_FILE'
                    }
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
